import React, { useState, useEffect } from 'react';
import { Printer, Settings, Scissors, Layers, Info, AlertTriangle, FileText, Ruler, Book, Calculator, feather, PenTool } from 'lucide-react';

// --- Constants & Utilities ---

const UNITS = {
  MM: 'mm',
  INCH: 'in',
};

const PAPER_SIZES = {
  LETTER: { name: 'US Letter', w: 8.5, h: 11, unit: 'in' },
  A4: { name: 'A4', w: 210, h: 297, unit: 'mm' },
  LEGAL: { name: 'Legal', w: 8.5, h: 14, unit: 'in' },
  A3: { name: 'A3', w: 297, h: 420, unit: 'mm' },
  TABLOID: { name: 'Tabloid', w: 11, h: 17, unit: 'in' },
};

const mmToIn = (mm) => mm / 25.4;
const inToMm = (inVal) => inVal * 25.4;

const convert = (val, from, to) => {
  if (from === to) return val;
  if (from === UNITS.MM && to === UNITS.INCH) return mmToIn(val);
  if (from === UNITS.INCH && to === UNITS.MM) return inToMm(val);
  return val;
};

// --- Components ---

const InputField = ({ label, value, onChange, step = 0.1, unit, disabled = false }) => (
  <div className="flex flex-col gap-1">
    <label className={`text-[10px] font-bold uppercase tracking-wider ${disabled ? 'text-gray-400' : 'text-gray-500'}`}>{label}</label>
    <div className="relative">
      <input
        type="number"
        value={value ? parseFloat(value.toFixed(4)) : 0}
        onChange={(e) => onChange(parseFloat(e.target.value) || 0)}
        step={step}
        disabled={disabled}
        className={`w-full p-2 pr-8 text-sm border rounded outline-none transition-all ${
            disabled 
            ? 'bg-gray-50 border-gray-200 text-gray-400' 
            : 'bg-white border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900 font-medium'
        }`}
      />
      <span className={`absolute right-3 top-2.5 text-xs ${disabled ? 'text-gray-300' : 'text-gray-400'}`}>{unit}</span>
    </div>
  </div>
);

// --- Main Application ---

export default function BookBinderLayout() {
  const [unit, setUnit] = useState(UNITS.INCH);
  const [paperSize, setPaperSize] = useState('LETTER');
  
  // Modes: 'BOARD' (Manual board size) or 'BLOCK' (Calculate from text block)
  const [calcMode, setCalcMode] = useState('BLOCK'); 

  // Text Block Dimensions - Defaults set for user's 9.5 x 6.5 paperback
  const [blockWidth, setBlockWidth] = useState(6.5);
  const [blockHeight, setBlockHeight] = useState(9.5);
  const [overhang, setOverhang] = useState(0.125); // "Squares" (1/8")
  
  // Board Dimensions
  const [boardWidth, setBoardWidth] = useState(6.5);
  const [boardHeight, setBoardHeight] = useState(9.75); // 9.5 + 0.125 + 0.125
  const [spineWidth, setSpineWidth] = useState(0.75);
  const [hingeGap, setHingeGap] = useState(0.3125); // 5/16" default for Leather
  
  // Material Settings
  const [turnIn, setTurnIn] = useState(0.75); // Wrap amount
  const [boardThickness, setBoardThickness] = useState(0.1); 
  const [cornerRadius, setCornerRadius] = useState(0.375); // 3/8" Rounded Corner

  const [showGuides, setShowGuides] = useState(true);
  const [splitPages, setSplitPages] = useState(false);

  // --- Effects ---

  // Auto-calculate board size when in BLOCK mode
  useEffect(() => {
    if (calcMode === 'BLOCK') {
        // Height = Block Height + (Top Overhang + Bottom Overhang)
        const newHeight = blockHeight + (overhang * 2);
        // Width = Block Width (Standard approximation)
        const newWidth = blockWidth;
        
        setBoardHeight(parseFloat(newHeight.toFixed(4)));
        setBoardWidth(parseFloat(newWidth.toFixed(4)));
    }
  }, [blockWidth, blockHeight, overhang, calcMode]);

  // Handle Unit Conversion
  const handleUnitChange = (newUnit) => {
    if (newUnit === unit) return;
    const convertState = (val) => parseFloat(convert(val, unit, newUnit).toFixed(4));
    
    setBoardWidth(convertState(boardWidth));
    setBoardHeight(convertState(boardHeight));
    setBlockWidth(convertState(blockWidth));
    setBlockHeight(convertState(blockHeight));
    setSpineWidth(convertState(spineWidth));
    setHingeGap(convertState(hingeGap));
    setTurnIn(convertState(turnIn));
    setBoardThickness(convertState(boardThickness));
    setOverhang(convertState(overhang));
    setCornerRadius(convertState(cornerRadius));
    
    setUnit(newUnit);
  };

  const applyMaterialPreset = (type) => {
      if (type === 'LEATHER') {
          // Thicker material needs wider hinge gap to open comfortably
          // 5/16" (0.3125) is standard for leather
          const val = unit === UNITS.INCH ? 0.3125 : 8;
          setHingeGap(val);
      } else {
          // Paper/Cloth can use tighter hinges
          // 1/4" (0.25) or roughly 6-7mm
          const val = unit === UNITS.INCH ? 0.25 : 6;
          setHingeGap(val);
      }
  };

  // --- Computed Layout Values ---
  const totalWidth = boardWidth * 2 + hingeGap * 2 + spineWidth;
  const fullCanvasWidth = totalWidth + turnIn * 2;
  const fullCanvasHeight = boardHeight + turnIn * 2;

  // Paper Dimensions
  const currentPaper = PAPER_SIZES[paperSize];
  const paperW = convert(currentPaper.w, currentPaper.unit, unit);
  const paperH = convert(currentPaper.h, currentPaper.unit, unit);

  // Check fit
  const fitsOnOnePage = fullCanvasWidth <= paperW && fullCanvasHeight <= paperH;

  // Auto-trigger split if doesn't fit? Optional.
  useEffect(() => {
      if (!fitsOnOnePage && !splitPages) {
         // Optionally auto-enable, but user choice is better usually.
         // keeping manual control for now.
      }
  }, [fitsOnOnePage]);

  const handlePrint = () => {
    window.print();
  };

  // --- Visualization Component ---
  const BoardLayout = ({ isPreview = false, viewMode = 'full' }) => {
    const u = unit; 
    
    // Viewport shifting for split printing
    let leftOffset = 0;
    if (viewMode === 'right') {
        // Shift layout to the left so the Right Board + Spine is visible in the container
        // We shift by (TurnIn + LeftBoard + Hinge)
        leftOffset = -(turnIn + boardWidth + hingeGap);
    }

    const containerStyle = {
      position: 'relative',
      width: `${fullCanvasWidth}${u}`,
      height: `${fullCanvasHeight}${u}`,
      marginLeft: `${leftOffset}${u}`, 
      transformOrigin: 'top left',
    };

    // Helper for styles
    const pos = (x, y, w, h) => ({
      position: 'absolute',
      left: `${x}${u}`,
      top: `${y}${u}`,
      width: `${w}${u}`,
      height: `${h}${u}`,
    });

    const GuideLine = ({ x, y, w, h, dashed = false }) => (
      <div style={{
        position: 'absolute',
        left: `${x}${u}`,
        top: `${y}${u}`,
        width: `${w}${u}`,
        height: `${h}${u}`,
        borderLeft: w === 0 ? `1px ${dashed ? 'dashed' : 'solid'} #999` : 'none',
        borderTop: h === 0 ? `1px ${dashed ? 'dashed' : 'solid'} #999` : 'none',
      }} />
    );

    const CornerMiter = ({ cx, cy, rotation }) => {
        // Standard offset for corner cut: 1.5 board thicknesses
        // This ensures the board corner is covered when material is wrapped
        const offset = boardThickness * 1.5; 
        const lineLen = turnIn * 2.5;

        return (
            <div style={{
                position: 'absolute',
                left: `${cx}${u}`,
                top: `${cy}${u}`,
                transform: `rotate(${rotation}deg)`,
                pointerEvents: 'none',
                zIndex: 10
            }}>
                {/* The Cut Line */}
                <div style={{
                    position: 'absolute',
                    top: `-${offset}${u}`,
                    left: `-${lineLen/2}${u}`,
                    width: `${lineLen}${u}`,
                    height: '0px',
                    borderTop: '1px solid red'
                }}></div>
                 <div style={{ position:'absolute', top: `-${offset + (unit === 'in' ? 0.2 : 5)}${u}`, left: '-10px', fontSize: '8px', color: 'red'}}>
                    Cut
                 </div>
            </div>
        )
    };

    return (
      <div className={`layout-container ${isPreview ? 'shadow-lg bg-white' : ''}`} style={containerStyle}>
        
        {/* Full Wrap Boundary (Turn-in area) */}
        <div style={{
           ...pos(0, 0, fullCanvasWidth, fullCanvasHeight),
           border: '1px dashed #333',
           boxSizing: 'border-box'
        }}>
            {!isPreview && (
                <>
                <div className="absolute top-1 left-1 text-[8px] text-gray-400">Wrap Edge</div>
                </>
            )}
        </div>

        {/* --- Boards --- */}
        {/* Using darker borders (2px solid #555) for high visibility on Davey board */}
        
        {/* Left Board (Back Cover) */}
        <div style={{
            ...pos(turnIn, turnIn, boardWidth, boardHeight),
            backgroundColor: isPreview ? '#e5e7eb' : 'transparent',
            border: '2px solid #555', 
            borderTopLeftRadius: `${cornerRadius}${u}`,
            borderBottomLeftRadius: `${cornerRadius}${u}`
        }}>
            <div className="absolute inset-0 flex items-center justify-center text-gray-400 text-[10px] font-bold uppercase tracking-widest opacity-50">
                Back Board
            </div>
        </div>

        {/* Right Board (Front Cover) */}
        <div style={{
            ...pos(turnIn + boardWidth + hingeGap + spineWidth + hingeGap, turnIn, boardWidth, boardHeight),
            backgroundColor: isPreview ? '#e5e7eb' : 'transparent',
            border: '2px solid #555',
            borderTopRightRadius: `${cornerRadius}${u}`,
            borderBottomRightRadius: `${cornerRadius}${u}`
        }}>
            <div className="absolute inset-0 flex items-center justify-center text-gray-400 text-[10px] font-bold uppercase tracking-widest opacity-50">
                Front Board
            </div>
        </div>

        {/* Spine */}
        <div style={{
            ...pos(turnIn + boardWidth + hingeGap, turnIn, spineWidth, boardHeight),
            backgroundColor: isPreview ? '#d1d5db' : 'transparent',
            border: '2px solid #555'
        }}>
            <div className="absolute inset-0 flex items-center justify-center text-gray-400 text-[10px] font-bold uppercase tracking-widest opacity-50 rotate-90">
                Spine
            </div>
        </div>

        {/* --- Guides --- */}
        {showGuides && (
          <>
            {/* Hinge Area Visuals */}
            <div style={{...pos(turnIn + boardWidth, turnIn, hingeGap, boardHeight), backgroundImage: 'linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 50%, #ddd 50%, #ddd 75%, transparent 75%, transparent)', backgroundSize: '4px 4px', opacity: 0.5}} />
            <div style={{...pos(turnIn + boardWidth + hingeGap + spineWidth, turnIn, hingeGap, boardHeight), backgroundImage: 'linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 50%, #ddd 50%, #ddd 75%, transparent 75%, transparent)', backgroundSize: '4px 4px', opacity: 0.5}} />

            {/* Center Line Vertical */}
            <GuideLine x={fullCanvasWidth / 2} y={0} w={0} h={fullCanvasHeight} dashed />
            
            {/* Center Line Horizontal */}
            <GuideLine x={0} y={fullCanvasHeight / 2} w={fullCanvasWidth} h={0} dashed />

            {/* Corner Miters */}
            <CornerMiter cx={turnIn} cy={turnIn} rotation={45} /> 
            <CornerMiter cx={fullCanvasWidth - turnIn} cy={turnIn} rotation={-45} />
            <CornerMiter cx={turnIn} cy={fullCanvasHeight - turnIn} rotation={135} /> 
            <CornerMiter cx={fullCanvasWidth - turnIn} cy={fullCanvasHeight - turnIn} rotation={-135} />
            
            {/* Dimension Labels (For Print Verification) */}
            <div className="hidden print:block">
                 {/* Spine Gap Label */}
                 <div style={{ position:'absolute', bottom: `${turnIn + boardHeight + 5}${u}`, left: `${turnIn + boardWidth}${u}`, width: `${hingeGap}${u}`, textAlign:'center', fontSize: '6px', borderLeft: '1px solid black', borderRight:'1px solid black' }}>
                    {hingeGap} Gap
                 </div>
            </div>
          </>
        )}
      </div>
    );
  };

  const CalibrationRuler = () => (
    <div className="mt-8 border-t border-gray-300 pt-2 print-only w-full">
        <div className="flex justify-between items-end">
            <div>
                 <div className="text-[10px] text-gray-500 mb-1 font-bold">CALIBRATION SCALE (MUST MEASURE EXACTLY)</div>
                 <div className="flex items-center gap-4">
                    {/* Inch Ruler */}
                    <div className="relative h-4 border border-black bg-white" style={{ width: '2in' }}>
                        {[0,1,2].map(i => (
                            <div key={i} className="absolute top-0 bottom-0 border-l border-black" style={{ left: `${i}in` }}></div>
                        ))}
                        <span className="absolute top-4 left-0 text-[8px]">0</span>
                        <span className="absolute top-4 right-0 text-[8px]">2 in</span>
                    </div>
                </div>
            </div>
            <div className="text-[8px] text-gray-400 text-right">
                Project: {blockWidth}x{blockHeight} Block | {boardWidth}x{boardHeight} Board | Leather Setup
            </div>
        </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-100 text-gray-800 font-sans flex flex-col md:flex-row print:bg-white print:block">
      
      {/* Sidebar Controls - Hidden on Print */}
      <div className="w-full md:w-96 bg-white shadow-xl z-10 flex flex-col h-auto md:h-screen overflow-y-auto print:hidden">
        <div className="p-5 bg-indigo-700 text-white shadow-md">
          <div className="flex items-center gap-2 mb-1">
            <Book className="w-5 h-5" />
            <h1 className="text-lg font-bold">BookBinder Layout</h1>
          </div>
          <p className="text-indigo-200 text-xs">Precision Template Generator</p>
        </div>

        <div className="p-6 space-y-8">
          
          {/* Section: Material Presets */}
          <section className="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
             <h2 className="text-xs font-bold text-indigo-800 uppercase mb-3 flex items-center gap-2">
                 <PenTool className="w-3 h-3" /> Material Presets
             </h2>
             <div className="flex gap-2">
                <button
                  onClick={() => applyMaterialPreset('LEATHER')}
                  className="flex-1 py-2 px-3 text-xs font-bold rounded shadow-sm bg-white text-indigo-700 border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-colors"
                >
                   Leather (Thin)
                   <span className="block text-[9px] font-normal opacity-75 mt-0.5">Wider Hinge (5/16")</span>
                </button>
                <button
                  onClick={() => applyMaterialPreset('CLOTH')}
                  className="flex-1 py-2 px-3 text-xs font-bold rounded shadow-sm bg-white text-gray-600 border border-gray-200 hover:bg-gray-100 transition-colors"
                >
                   Paper / Cloth
                   <span className="block text-[9px] font-normal opacity-75 mt-0.5">Tight Hinge (1/4")</span>
                </button>
             </div>
          </section>

          {/* Section: Input Mode */}
          <section className="space-y-2">
             <div className="flex rounded-md shadow-sm" role="group">
                <button
                  onClick={() => setCalcMode('BLOCK')}
                  className={`flex-1 px-4 py-2 text-xs font-bold uppercase tracking-wider border rounded-l-lg ${
                    calcMode === 'BLOCK' ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-300 hover:bg-gray-50'
                  }`}
                >
                   1. Text Block
                </button>
                <button
                  onClick={() => setCalcMode('BOARD')}
                  className={`flex-1 px-4 py-2 text-xs font-bold uppercase tracking-wider border rounded-r-lg ${
                    calcMode === 'BOARD' ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-300 hover:bg-gray-50'
                  }`}
                >
                   2. Manual Board
                </button>
             </div>
          </section>

          {/* Section: Main Dimensions */}
          <section className="space-y-4">
            
            {calcMode === 'BLOCK' && (
                <div className="bg-gray-50 p-4 rounded border border-gray-200 space-y-4">
                    <div className="flex items-center gap-2 text-gray-700">
                        <Calculator className="w-3 h-3" />
                        <span className="text-xs font-bold uppercase">Internal Block Size</span>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        <InputField label="Block Width" value={blockWidth} onChange={setBlockWidth} unit={unit} />
                        <InputField label="Block Height" value={blockHeight} onChange={setBlockHeight} unit={unit} />
                    </div>
                    <div className="grid grid-cols-1 gap-3">
                        <InputField label="Overhang (Squares)" value={overhang} onChange={setOverhang} step={0.0625} unit={unit} />
                    </div>
                </div>
            )}
            
            <div className={`space-y-3 pt-2 ${calcMode === 'BLOCK' ? 'opacity-80' : ''}`}>
                 <div className="flex items-center justify-between border-b pb-1">
                     <span className="text-xs font-bold text-gray-900 uppercase">Board Output</span>
                     {calcMode === 'BLOCK' && <span className="text-[10px] text-indigo-600 font-mono">(Calculated)</span>}
                 </div>
                <div className="grid grid-cols-2 gap-3">
                   <InputField label="Board Width" value={boardWidth} onChange={setBoardWidth} unit={unit} disabled={calcMode === 'BLOCK'} />
                   <InputField label="Board Height" value={boardHeight} onChange={setBoardHeight} unit={unit} disabled={calcMode === 'BLOCK'} />
                </div>
            </div>

            <div className="grid grid-cols-2 gap-3 pt-2">
               <InputField label="Spine Width" value={spineWidth} onChange={setSpineWidth} unit={unit} />
               <InputField label="Hinge Gap" value={hingeGap} onChange={setHingeGap} step={0.0625} unit={unit} />
            </div>
          </section>

          {/* Section: Material & Style */}
          <section className="space-y-4">
            <h2 className="text-sm font-bold text-gray-900 flex items-center gap-2 border-b pb-2">
              <Scissors className="w-4 h-4" /> Margins & Corners
            </h2>
            
            <div className="grid grid-cols-2 gap-3">
               <InputField label="Wrap / Turn-In" value={turnIn} onChange={setTurnIn} unit={unit} />
               <InputField label="Board Thickness" value={boardThickness} onChange={setBoardThickness} step={0.01} unit={unit} />
            </div>
            
            <div className="grid grid-cols-1 gap-3 bg-indigo-50 p-2 rounded border border-indigo-100">
               <InputField label="Corner Radius (Outer)" value={cornerRadius} onChange={setCornerRadius} step={0.125} unit={unit} />
               <p className="text-[9px] text-indigo-800">Defines the curve cut on your Davey board.</p>
            </div>
          </section>
            
          {/* Section: Printer Settings */}
          <section className="space-y-4 pt-4 border-t border-gray-200">
               <div className="flex items-center justify-between">
                    <h2 className="text-sm font-bold text-gray-900 flex items-center gap-2">
                        <Printer className="w-4 h-4" /> Printer Setup
                    </h2>
                    <div className="flex bg-gray-100 rounded p-1">
                        <button onClick={() => handleUnitChange(UNITS.INCH)} className={`px-2 py-0.5 text-[10px] rounded ${unit === UNITS.INCH ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}>IN</button>
                        <button onClick={() => handleUnitChange(UNITS.MM)} className={`px-2 py-0.5 text-[10px] rounded ${unit === UNITS.MM ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}>MM</button>
                    </div>
               </div>

               <div>
                 <select 
                   value={paperSize}
                   onChange={(e) => setPaperSize(e.target.value)}
                   className="mt-1 w-full p-2 text-sm bg-gray-50 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                 >
                   {Object.entries(PAPER_SIZES).map(([key, val]) => (
                     <option key={key} value={key}>{val.name} ({val.w} x {val.h} {val.unit})</option>
                   ))}
                 </select>
               </div>
          </section>

          {/* Print Action */}
          <div className="pt-4 pb-10">
             {!fitsOnOnePage && (
                 <div className="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-md flex gap-3">
                     <AlertTriangle className="w-5 h-5 text-amber-500 flex-shrink-0" />
                     <div className="space-y-2">
                         <p className="text-xs text-amber-900 font-medium">
                             Layout too wide for paper.
                         </p>
                         <div className="flex items-center gap-2">
                             <input 
                               type="checkbox" 
                               id="split" 
                               checked={splitPages} 
                               onChange={(e) => setSplitPages(e.target.checked)}
                               className="rounded text-amber-600 focus:ring-amber-500"
                             />
                             <label htmlFor="split" className="text-xs font-bold text-amber-900 cursor-pointer">Split across 2 pages?</label>
                         </div>
                     </div>
                 </div>
             )}

             <button 
               onClick={handlePrint}
               className="w-full py-4 bg-gray-900 hover:bg-black text-white rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all transform active:scale-[0.98]"
             >
               <Printer className="w-5 h-5" />
               PRINT TEMPLATE
             </button>
             <p className="text-center text-[10px] text-gray-400 mt-2">Scale: "100%" or "Actual Size"</p>
          </div>

        </div>
      </div>

      {/* Main Preview Area - Screen Only */}
      <div className="flex-1 bg-slate-200 overflow-auto p-4 md:p-8 flex flex-col items-center justify-start md:justify-center print:hidden relative min-h-screen">
        
        <div className="bg-white rounded-lg shadow-sm p-2 mb-6 flex items-center gap-3 text-xs text-gray-500">
             <Info className="w-4 h-4 text-indigo-500" />
             <span>Preview: {boardWidth}" x {boardHeight}" Boards | {cornerRadius}" Corners</span>
        </div>

        {/* The Paper Context */}
        <div 
           className="relative transition-all duration-500 ease-in-out origin-top md:origin-center"
           style={{ 
               width: splitPages ? `${paperW * 2.1}in` : `${paperW}in`, // Visual approximation
               height: `${paperH}in`,
               display: 'flex',
               gap: '2rem',
               justifyContent: 'center',
               transform: 'scale(0.65)', 
           }}
        >
             {!splitPages ? (
                 <div className="relative bg-white shadow-2xl" style={{ width: `${paperW}${currentPaper.unit}`, height: `${paperH}${currentPaper.unit}` }}>
                      <div className="absolute -top-8 left-0 text-sm font-bold text-gray-400 uppercase tracking-widest">{currentPaper.name}</div>
                      
                      {!fitsOnOnePage && !splitPages && (
                          <div className="absolute inset-0 border-4 border-dashed border-red-400 bg-red-100 bg-opacity-20 pointer-events-none flex items-center justify-center z-50">
                             <span className="bg-red-500 text-white text-lg font-bold px-4 py-2 rounded shadow-lg transform -rotate-12">PAPER TOO SMALL</span>
                          </div>
                      )}

                      <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                          <BoardLayout isPreview={true} />
                      </div>
                 </div>
             ) : (
                <>
                    <div className="relative bg-white shadow-2xl" style={{ width: `${paperW}${currentPaper.unit}`, height: `${paperH}${currentPaper.unit}` }}>
                        <div className="absolute -top-8 left-0 text-sm font-bold text-gray-400 uppercase tracking-widest">Sheet 1 (Left)</div>
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                            <div style={{ overflow: 'hidden', width: `${turnIn + boardWidth + hingeGap + spineWidth}${unit}`, height: `${fullCanvasHeight}${unit}`, position: 'relative' }}>
                                <BoardLayout isPreview={true} viewMode="left" />
                            </div>
                        </div>
                    </div>
                    <div className="relative bg-white shadow-2xl" style={{ width: `${paperW}${currentPaper.unit}`, height: `${paperH}${currentPaper.unit}` }}>
                        <div className="absolute -top-8 left-0 text-sm font-bold text-gray-400 uppercase tracking-widest">Sheet 2 (Right)</div>
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                            <div style={{ overflow: 'hidden', width: `${turnIn + boardWidth + hingeGap + spineWidth}${unit}`, height: `${fullCanvasHeight}${unit}`, position: 'relative' }}>
                                 <div style={{ position: 'absolute', right: 0 }}>
                                    <BoardLayout isPreview={true} viewMode="right" />
                                 </div>
                            </div>
                        </div>
                    </div>
                </>
             )}
        </div>
      </div>

      {/* PRINT MEDIA QUERY AREA - Only visible when printing */}
      <div className="hidden print:block absolute top-0 left-0 w-full h-full bg-white z-[9999]">
         <style>{`
            @media print {
                @page { 
                    size: ${paperSize === 'LETTER' ? 'letter' : paperSize === 'LEGAL' ? 'legal' : paperSize === 'TABLOID' ? '11in 17in' : 'A4'} portrait; 
                    margin: 0;
                }
                body { 
                    margin: 0; 
                    padding: 0; 
                    background: white;
                }
                .print-page {
                    page-break-after: always;
                    width: 100vw;
                    height: 100vh;
                    position: relative;
                    overflow: hidden;
                }
            }
         `}</style>
         
         {!splitPages ? (
             <div className="print-page">
                 <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }}>
                     <BoardLayout />
                     <CalibrationRuler />
                 </div>
                 <div className="absolute top-8 left-8 text-xs font-mono text-gray-400">
                     BookBinder Layout | {new Date().toLocaleDateString()}
                 </div>
             </div>
         ) : (
            <>
                <div className="print-page">
                    <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }}>
                        {/* Left Page View */}
                        <div style={{ overflow: 'hidden', width: `${turnIn + boardWidth + hingeGap + spineWidth + 0.1}${unit}`, height: `${fullCanvasHeight}${unit}`, position: 'relative' }}>
                             <BoardLayout viewMode="left" />
                        </div>
                        <CalibrationRuler />
                    </div>
                    <div className="absolute top-8 left-8 text-xs font-mono text-gray-500">
                        Sheet 1/2 (Left Side) - Cut/Align at Spine Edge
                    </div>
                </div>

                <div className="print-page">
                    <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }}>
                         {/* Right Page View */}
                        <div style={{ overflow: 'hidden', width: `${turnIn + boardWidth + hingeGap + spineWidth + 0.1}${unit}`, height: `${fullCanvasHeight}${unit}`, position: 'relative' }}>
                             <div style={{ position: 'absolute', right: 0 }}>
                                <BoardLayout viewMode="right" />
                             </div>
                        </div>
                        <CalibrationRuler />
                    </div>
                    <div className="absolute top-8 left-8 text-xs font-mono text-gray-500">
                        Sheet 2/2 (Right Side) - Cut/Align at Spine Edge
                    </div>
                </div>
            </>
         )}

      </div>

    </div>
  );
}


