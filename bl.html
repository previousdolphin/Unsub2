<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookBinder Layout Tool</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Force background graphics for grey fills */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Print Specifics */
        @media print {
            @page { margin: 0; size: auto; }
            body, html { margin: 0; padding: 0; background: white; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            
            /* Ensure pages break correctly */
            .sheet-container {
                break-after: page;
                page-break-after: always;
                overflow: hidden;
            }
        }

        /* Screen Preview of Print Mode */
        .print-mode-screen {
            background-color: #525252;
            min-height: 100vh;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
        }

        .sheet-shadow {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="root"></div>

    <!-- Error Trap: If React fails, this shows -->
    <div id="error-msg" style="display:none; padding: 20px; color: red; text-align: center;">
        App failed to load. Please check your internet connection (libraries load from CDN).
    </div>
    <script>
        window.onerror = function() { document.getElementById('error-msg').style.display = 'block'; };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons ---
        const Icon = ({ name }) => {
            const icons = {
                printer: <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><path d="M6 14h12v8H6z"/>,
                x: <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>,
                alert: <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>,
                arrowLeft: <line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/>
            };
            return <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{icons[name]}</svg>;
        };

        // --- Units & Constants ---
        const UNITS = { MM: 'mm', INCH: 'in' };
        const PAPER_SIZES = {
            LETTER: { name: 'US Letter', w: 8.5, h: 11, unit: 'in' },
            A4: { name: 'A4', w: 210, h: 297, unit: 'mm' },
            LEGAL: { name: 'Legal', w: 8.5, h: 14, unit: 'in' },
        };

        const convert = (val, from, to) => {
            if (from === to) return val;
            if (from === 'mm' && to === 'in') return val / 25.4;
            if (from === 'in' && to === 'mm') return val * 25.4;
            return val;
        };

        // --- Components ---
        const InputField = ({ label, value, onChange, unit, disabled }) => (
            <div className="flex flex-col">
                <label className="text-[10px] font-bold uppercase text-gray-500 mb-1">{label}</label>
                <div className="relative">
                    <input type="number" value={value} onChange={(e) => onChange(parseFloat(e.target.value)||0)} disabled={disabled} className={`w-full p-2 pr-6 text-sm border rounded ${disabled ? 'bg-gray-50 text-gray-400' : 'bg-white'}`} />
                    <span className="absolute right-2 top-2 text-xs text-gray-400">{unit}</span>
                </div>
            </div>
        );

        const CalibrationRuler = () => (
            <div className="mt-8 border-t border-gray-300 pt-2 w-full">
                <div className="flex justify-between items-end">
                    <div>
                        <div className="text-[10px] text-gray-500 mb-1 font-bold">SCALE CHECK (2 INCH)</div>
                        <div className="relative h-4 border border-black bg-white" style={{ width: '2in' }}>
                            <div className="absolute top-0 bottom-0 left-0 border-l border-black"></div>
                            <div className="absolute top-0 bottom-0 left-[1in] border-l border-black"></div>
                            <div className="absolute top-0 bottom-0 left-[2in] border-l border-black"></div>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- Layout Renderer (The visual core) ---
        const BoardLayout = ({ unit, boardWidth, boardHeight, spineWidth, hingeGap, turnIn, boardThickness, cornerRadius, viewMode, isPreview }) => {
            const u = unit;
            
            // Calculate Total Canvas Size
            const fullW = (boardWidth * 2) + (hingeGap * 2) + spineWidth + (turnIn * 2);
            const fullH = boardHeight + (turnIn * 2);

            // Shift Logic for Split Views
            let leftShift = 0;
            if (viewMode === 'right') {
                leftShift = -(turnIn + boardWidth + hingeGap);
            }

            // Styles
            const containerStyle = {
                position: 'relative',
                width: `${fullW}${u}`,
                height: `${fullH}${u}`,
                marginLeft: `${leftShift}${u}`,
                transformOrigin: 'top left'
            };

            const pos = (x, y, w, h) => ({
                position: 'absolute',
                left: `${x}${u}`,
                top: `${y}${u}`,
                width: `${w}${u}`,
                height: `${h}${u}`
            });

            // Miter Guide Logic
            const miterOffset = boardThickness * 1.5;
            const CornerMiter = ({ cx, cy, rot }) => (
                <div style={{ position: 'absolute', left: `${cx}${u}`, top: `${cy}${u}`, transform: `rotate(${rot}deg)`, pointerEvents: 'none', zIndex: 10 }}>
                    <div style={{ position: 'absolute', top: `-${miterOffset}${u}`, left: `-${turnIn}${u}`, width: `${turnIn*2}${u}`, height: 0, borderTop: '1px solid red' }}></div>
                    <div style={{ position: 'absolute', top: `-${miterOffset+0.15}${u}`, left: 0, fontSize: '8px', color: 'red' }}>Cut</div>
                </div>
            );

            return (
                <div style={containerStyle}>
                    {/* Wrap Boundary */}
                    <div style={{ ...pos(0,0,fullW,fullH), border: '1px dashed #999', boxSizing:'border-box' }}>
                        {!isPreview && <span className="absolute top-1 left-1 text-[8px] text-gray-400">Wrap</span>}
                    </div>

                    {/* Left Board */}
                    <div style={{ ...pos(turnIn, turnIn, boardWidth, boardHeight), border:'2px solid #444', backgroundColor: isPreview ? '#e5e7eb' : '#f3f4f6', borderRadius: `${cornerRadius}${u} 0 0 ${cornerRadius}${u}` }}>
                        <div className="flex items-center justify-center h-full text-gray-300 text-[10px] font-bold uppercase tracking-widest">Back</div>
                    </div>

                    {/* Right Board */}
                    <div style={{ ...pos(turnIn + boardWidth + hingeGap + spineWidth + hingeGap, turnIn, boardWidth, boardHeight), border:'2px solid #444', backgroundColor: isPreview ? '#e5e7eb' : '#f3f4f6', borderRadius: `0 ${cornerRadius}${u} ${cornerRadius}${u} 0` }}>
                        <div className="flex items-center justify-center h-full text-gray-300 text-[10px] font-bold uppercase tracking-widest">Front</div>
                    </div>

                    {/* Spine */}
                    <div style={{ ...pos(turnIn + boardWidth + hingeGap, turnIn, spineWidth, boardHeight), border:'2px solid #444', backgroundColor: isPreview ? '#d1d5db' : '#e5e5e5' }}></div>

                    {/* Guides */}
                    <div style={{ ...pos(turnIn + boardWidth, turnIn, hingeGap, boardHeight), opacity: 0.3, background: 'repeating-linear-gradient(45deg, #ccc 0, #ccc 1px, transparent 0, transparent 4px)' }}></div>
                    <div style={{ ...pos(turnIn + boardWidth + hingeGap + spineWidth, turnIn, hingeGap, boardHeight), opacity: 0.3, background: 'repeating-linear-gradient(45deg, #ccc 0, #ccc 1px, transparent 0, transparent 4px)' }}></div>

                    {/* Center Lines */}
                    <div style={{ position: 'absolute', top: 0, bottom: 0, left: `${fullW/2}${u}`, borderLeft: '1px dashed #aaa' }}></div>
                    <div style={{ position: 'absolute', left: 0, right: 0, top: `${fullH/2}${u}`, borderTop: '1px dashed #aaa' }}></div>

                    {/* Miters */}
                    <CornerMiter cx={turnIn} cy={turnIn} rot={45} />
                    <CornerMiter cx={fullW-turnIn} cy={turnIn} rot={-45} />
                    <CornerMiter cx={turnIn} cy={fullH-turnIn} rot={135} />
                    <CornerMiter cx={fullW-turnIn} cy={fullH-turnIn} rot={-135} />

                    {/* Print Label */}
                    <div style={{ position: 'absolute', bottom: `${turnIn + boardHeight + 0.1}${u}`, left: `${turnIn + boardWidth}${u}`, width: `${hingeGap}${u}`, textAlign: 'center', fontSize: '6px', borderLeft: '1px solid black', borderRight: '1px solid black' }}>
                        {hingeGap}
                    </div>
                </div>
            );
        };

        // --- Main App ---
        function BookBinder() {
            // State
            const [printMode, setPrintMode] = useState(false);
            const [calcMode, setCalcMode] = useState('BLOCK');
            const [unit, setUnit] = useState(UNITS.INCH);
            const [paperSize, setPaperSize] = useState('LETTER');
            
            // Dimensions
            const [blockW, setBlockW] = useState(6.5);
            const [blockH, setBlockH] = useState(9.5);
            const [overhang, setOverhang] = useState(0.125);
            
            const [boardW, setBoardW] = useState(6.5);
            const [boardH, setBoardH] = useState(9.75);
            const [spineW, setSpineW] = useState(0.75);
            const [hinge, setHinge] = useState(0.3125);
            const [turnIn, setTurnIn] = useState(0.75);
            const [thickness, setThickness] = useState(0.1);
            const [radius, setRadius] = useState(0.375);
            const [split, setSplit] = useState(false);

            // Calculation Effect
            useEffect(() => {
                if (calcMode === 'BLOCK') {
                    setBoardH(parseFloat((blockH + (overhang * 2)).toFixed(4)));
                    setBoardW(parseFloat(blockW.toFixed(4)));
                }
            }, [blockW, blockH, overhang, calcMode]);

            // Presets
            const setPreset = (type) => {
                const isIn = unit === UNITS.INCH;
                setHinge(type === 'LEATHER' ? (isIn ? 0.3125 : 8) : (isIn ? 0.25 : 6));
            };

            const toggleUnit = () => {
                const newU = unit === UNITS.INCH ? UNITS.MM : UNITS.INCH;
                const c = (v) => parseFloat(convert(v, unit, newU).toFixed(4));
                setBoardW(c(boardW)); setBoardH(c(boardH));
                setBlockW(c(blockW)); setBlockH(c(blockH));
                setSpineW(c(spineW)); setHinge(c(hinge));
                setTurnIn(c(turnIn)); setThickness(c(thickness));
                setOverhang(c(overhang)); setRadius(c(radius));
                setUnit(newU);
            };

            // Size Checks
            const paper = PAPER_SIZES[paperSize];
            const pW = convert(paper.w, paper.unit, unit);
            const pH = convert(paper.h, paper.unit, unit);
            const fullW = (boardW * 2) + (hinge * 2) + spineW + (turnIn * 2);
            const fits = fullW <= pW;

            const layoutProps = { unit, boardWidth: boardW, boardHeight: boardH, spineWidth: spineW, hingeGap: hinge, turnIn, boardThickness: thickness, cornerRadius: radius };

            // --- VIEW: PRINT MODE (The "PDF Generator") ---
            if (printMode) {
                const sheetStyle = { 
                    width: `${pW}${unit}`, 
                    height: `${pH}${unit}`, 
                    position: 'relative', 
                    background: 'white', 
                    overflow: 'hidden' 
                };

                return (
                    <div className="print-mode-screen">
                        {/* Header (Hidden on Print) */}
                        <div className="fixed top-0 left-0 right-0 p-4 bg-gray-900 text-white flex justify-between items-center z-50 no-print shadow-lg">
                            <div>
                                <h2 className="font-bold text-lg">Print View</h2>
                                <p className="text-xs text-gray-300">Tap Share â†’ Print to save as PDF</p>
                            </div>
                            <button onClick={() => setPrintMode(false)} className="bg-white text-gray-900 px-4 py-2 rounded font-bold text-sm flex gap-2 items-center">
                                <Icon name="x" /> Exit
                            </button>
                        </div>

                        {/* Printable Sheets */}
                        {!split ? (
                            <div className="sheet-container sheet-shadow" style={sheetStyle}>
                                <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }}>
                                    <BoardLayout {...layoutProps} />
                                    <CalibrationRuler />
                                </div>
                                <div className="absolute top-8 left-8 text-xs text-gray-400">BookBinder Sheet</div>
                            </div>
                        ) : (
                            <>
                                {/* Sheet 1 */}
                                <div className="sheet-container sheet-shadow" style={sheetStyle}>
                                    <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }}>
                                        <div style={{ overflow: 'hidden', width: `${turnIn+boardW+hinge+spineW+0.1}${unit}`, height: `${boardH+(turnIn*2)}${unit}`, position:'relative' }}>
                                            <BoardLayout {...layoutProps} viewMode="left" />
                                        </div>
                                        <CalibrationRuler />
                                    </div>
                                    <div className="absolute top-8 left-8 text-xs text-gray-400">Sheet 1 (Left) - Align at Spine</div>
                                </div>
                                {/* Sheet 2 */}
                                <div className="sheet-container sheet-shadow" style={sheetStyle}>
                                    <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }}>
                                        <div style={{ overflow: 'hidden', width: `${turnIn+boardW+hinge+spineW+0.1}${unit}`, height: `${boardH+(turnIn*2)}${unit}`, position:'relative' }}>
                                            <div style={{ position: 'absolute', right: 0 }}>
                                                <BoardLayout {...layoutProps} viewMode="right" />
                                            </div>
                                        </div>
                                        <CalibrationRuler />
                                    </div>
                                    <div className="absolute top-8 left-8 text-xs text-gray-400">Sheet 2 (Right) - Align at Spine</div>
                                </div>
                            </>
                        )}
                    </div>
                );
            }

            // --- VIEW: EDITOR MODE ---
            return (
                <div className="flex flex-col md:flex-row min-h-screen">
                    {/* Controls Sidebar */}
                    <div className="w-full md:w-80 bg-white shadow-xl z-20 flex flex-col h-auto md:h-screen overflow-y-auto">
                        <div className="p-4 bg-indigo-600 text-white shadow">
                            <h1 className="font-bold text-lg">BookBinder Tool</h1>
                            <p className="text-xs opacity-75">Layout & Print Generator</p>
                        </div>
                        
                        <div className="p-4 space-y-6">
                            {/* Material Presets */}
                            <div className="bg-indigo-50 p-3 rounded border border-indigo-100">
                                <label className="text-xs font-bold text-indigo-900 block mb-2">MATERIAL</label>
                                <div className="flex gap-2">
                                    <button onClick={() => setPreset('LEATHER')} className="flex-1 py-1 px-2 text-xs font-bold bg-white border border-indigo-200 rounded text-indigo-700 shadow-sm">Leather (Thin)</button>
                                    <button onClick={() => setPreset('CLOTH')} className="flex-1 py-1 px-2 text-xs font-bold bg-white border border-gray-200 rounded text-gray-600 shadow-sm">Cloth/Paper</button>
                                </div>
                            </div>

                            {/* Dimensions */}
                            <div className="space-y-3">
                                <div className="flex items-center justify-between">
                                    <label className="text-xs font-bold text-gray-500">DIMENSIONS</label>
                                    <button onClick={toggleUnit} className="text-[10px] bg-gray-200 px-2 py-0.5 rounded font-bold">{unit}</button>
                                </div>
                                
                                <div className="flex border rounded overflow-hidden mb-2">
                                    <button onClick={() => setCalcMode('BLOCK')} className={`flex-1 py-1 text-xs font-bold ${calcMode==='BLOCK'?'bg-gray-800 text-white':'bg-white text-gray-600'}`}>Text Block</button>
                                    <button onClick={() => setCalcMode('BOARD')} className={`flex-1 py-1 text-xs font-bold ${calcMode==='BOARD'?'bg-gray-800 text-white':'bg-white text-gray-600'}`}>Manual Board</button>
                                </div>

                                {calcMode === 'BLOCK' && (
                                    <div className="grid grid-cols-2 gap-2 bg-gray-50 p-2 rounded">
                                        <InputField label="Block W" value={blockW} onChange={setBlockW} unit={unit} />
                                        <InputField label="Block H" value={blockH} onChange={setBlockH} unit={unit} />
                                        <div className="col-span-2"><InputField label="Overhang" value={overhang} onChange={setOverhang} unit={unit} /></div>
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-2">
                                    <InputField label="Board W" value={boardW} onChange={setBoardW} unit={unit} disabled={calcMode==='BLOCK'} />
                                    <InputField label="Board H" value={boardH} onChange={setBoardH} unit={unit} disabled={calcMode==='BLOCK'} />
                                    <InputField label="Spine W" value={spineW} onChange={setSpineW} unit={unit} />
                                    <InputField label="Hinge" value={hinge} onChange={setHinge} unit={unit} />
                                    <InputField label="Turn-In" value={turnIn} onChange={setTurnIn} unit={unit} />
                                    <InputField label="Radius" value={radius} onChange={setRadius} unit={unit} />
                                </div>
                            </div>

                            {/* Printer Config */}
                            <div className="border-t pt-4">
                                <div className="mb-2">
                                    <label className="text-xs font-bold text-gray-500 block mb-1">PAPER SIZE</label>
                                    <select value={paperSize} onChange={(e) => setPaperSize(e.target.value)} className="w-full text-sm border p-2 rounded bg-white">
                                        {Object.entries(PAPER_SIZES).map(([k,v]) => <option key={k} value={k}>{v.name}</option>)}
                                    </select>
                                </div>

                                {!fits && (
                                    <div className="p-2 bg-amber-50 border border-amber-200 rounded flex items-center gap-2 mb-2">
                                        <Icon name="alert" />
                                        <label className="text-xs font-bold text-amber-800 flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" checked={split} onChange={(e) => setSplit(e.target.checked)} />
                                            Split Across 2 Pages?
                                        </label>
                                    </div>
                                )}

                                <button onClick={() => setPrintMode(true)} className="w-full py-3 bg-gray-900 text-white font-bold rounded shadow-lg hover:bg-black transition-colors flex items-center justify-center gap-2">
                                    <Icon name="printer" /> GENERATE PRINTABLE SHEETS
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Preview Area */}
                    <div className="flex-1 bg-gray-200 p-8 flex items-center justify-center overflow-auto relative">
                        <div style={{ transform: 'scale(0.65)', transformOrigin: 'top center' }}>
                            {!split ? (
                                <div className="bg-white shadow-xl relative" style={{ width: `${pW}${unit}`, height: `${pH}${unit}` }}>
                                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                                        <BoardLayout {...layoutProps} isPreview={true} />
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center text-gray-500 font-bold">Split View Active<br/>Click "Generate" to see pages</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BookBinder />);
    </script>
</body>
</html>

